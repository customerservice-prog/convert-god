{% load static %}
{% extends "base.html" %}

{% block content %}
  <div class="card" style="margin-bottom:14px">
    <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap">
      <img src="{% static 'app/convert-god.jpg' %}" alt="Convert God" style="width:140px; height:140px; object-fit:contain; border-radius:18px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);" />
      <div style="min-width:0">
        <h1 style="margin:0 0 8px">Convert God</h1>
        <div class="muted" style="max-width: 80ch; line-height:1.45">
          <p style="margin:0 0 10px">Convert God is a private file converter. Max upload: <b>1GB</b>.</p>
          <p style="margin:0"><b>How to use:</b> 1) Choose a file 2) Pick an output format 3) Click Convert 4) Download when ready.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <div style="display:flex; flex-direction:column; gap:10px; width:100%">
        <input id="url" type="text" placeholder="Paste a direct file URL (or YouTube URL for preview)" style="height:48px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.35);color:#fff;padding:0 12px;font-weight:850;" />
        <input id="file" type="file" style="flex: 1 1 420px; width:100%" />
        <div id="ytPreview" class="muted" style="display:none; margin-top:2px"></div>
      </div>
    </div>

    <div class="row" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center; margin-top:12px">
      <select id="preset" style="flex: 1 1 220px; height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.35);color:#fff;padding:0 12px;font-weight:900;">
        <option value="original">MP4 (Original)</option>
        <option value="1080p">MP4 (1080p)</option>
        <option value="720p" selected>MP4 (720p)</option>
        <option value="480p">MP4 (480p)</option>
      </select>
      <button id="convertBtn" disabled style="flex: 0 0 auto; height:44px;border-radius:12px;border:1px solid rgba(0,170,255,.45);background:rgba(0,170,255,.18);color:#fff;padding:0 14px;font-weight:1000;cursor:pointer;">Convert</button>
    </div>

    <div style="margin-top:14px;height:14px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10)">
      <div id="bar" style="height:100%;width:0%;background:linear-gradient(90deg,#00aaff,#00ff99);"></div>
    </div>

    <div id="status" class="muted" style="margin-top:10px">Select a file.</div>

    <div style="margin-top:14px" id="downloadWrap" hidden>
      <a id="downloadBtn" href="#" target="_blank" rel="noopener"
         style="display:inline-flex;align-items:center;justify-content:center;height:44px;padding:0 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);text-decoration:none;color:#fff;background:rgba(255,255,255,.08);font-weight:1000">Download</a>
    </div>
  </div>

<script>
const urlEl = document.getElementById('url');
const fileEl = document.getElementById('file');
const presetEl = document.getElementById('preset');
const btn = document.getElementById('convertBtn');
const statusEl = document.getElementById('status');
const bar = document.getElementById('bar');
const dlWrap = document.getElementById('downloadWrap');
const dlBtn = document.getElementById('downloadBtn');
const ytPreview = document.getElementById('ytPreview');

function setStatus(t){ statusEl.textContent = t; }
function setProgress(p){ bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }

function hasAnyInput(){
  const f = fileEl.files && fileEl.files[0];
  const u = (urlEl.value || '').trim();
  return !!f || !!u;
}

async function refreshYouTubePreview(){
  const u = (urlEl.value || '').trim();
  ytPreview.style.display = 'none';
  ytPreview.textContent = '';
  if (!u) return;
  if (!/youtu\.be\//i.test(u) && !/youtube\.com\//i.test(u)) return;

  try{
    const res = await fetch('/api/youtube/preview?url=' + encodeURIComponent(u));
    const data = await res.json();
    if (!data.ok) return;
    const p = data.preview;
    ytPreview.style.display = 'block';
    ytPreview.innerHTML = `YouTube preview: <b>${(p.title||'').replaceAll('<','&lt;')}</b>`;
  }catch(e){}
}

fileEl.addEventListener('change', () => {
  const f = fileEl.files && fileEl.files[0];
  btn.disabled = !hasAnyInput();
  dlWrap.hidden = true;
  setProgress(0);
  setStatus(f ? `Ready: ${f.name} (${Math.round(f.size/1024/1024)} MB)` : (hasAnyInput()? 'Ready.' : 'Select a file or paste a URL.'));
});

urlEl.addEventListener('input', () => {
  btn.disabled = !hasAnyInput();
  dlWrap.hidden = true;
  refreshYouTubePreview();
});

async function uploadFile(f){
  const fd = new FormData();
  fd.append('file', f);
  const res = await fetch('/api/uploads', { method:'POST', body: fd });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || 'upload failed');
  return data;
}

async function inputFromUrl(url){
  const res = await fetch('/api/inputs/from-url', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ url })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || 'url fetch failed');
  return data;
}

async function createJob(input_key, input_size_bytes, preset){
  const res = await fetch('/api/jobs', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ input_key, input_size_bytes, preset })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || 'job create failed');
  return data.id;
}

async function pollJob(id){
  const res = await fetch(`/api/jobs/${id}`);
  return await res.json();
}

btn.addEventListener('click', async () => {
  const f = fileEl.files && fileEl.files[0];
  const u = (urlEl.value || '').trim();
  if (!f && !u) return;

  btn.disabled = true;
  dlWrap.hidden = true;
  setProgress(2);

  try{
    let inputKey = null;
    let inputSize = 0;

    if (u){
      setStatus('Fetching URL…');
      const up = await inputFromUrl(u);
      inputKey = up.key;
      inputSize = up.size || 0;
    } else {
      setStatus('Uploading…');
      const up = await uploadFile(f);
      inputKey = up.key;
      inputSize = up.size || f.size;
    }

    setStatus('Queued…');
    const jobId = await createJob(inputKey, inputSize, presetEl.value);

    setStatus('Processing…');
    let done = false;
    while(!done){
      await new Promise(r => setTimeout(r, 1200));
      const data = await pollJob(jobId);
      if (!data.ok) throw new Error(data.error || 'poll failed');
      const j = data.job;
      setProgress(j.progress || 0);

      if (j.status === 'done'){
        setStatus('Done.');
        if (j.download_url){
          dlBtn.href = j.download_url;
          dlWrap.hidden = false;
        }
        done = true;
      } else if (j.status === 'failed'){
        throw new Error(j.error || 'conversion failed');
      } else {
        setStatus(`Status: ${j.status} (${j.progress || 0}%)`);
      }
    }
  }catch(e){
    setStatus('Error: ' + (e.message || e));
  }finally{
    btn.disabled = false;
  }
});
</script>
{% endblock %}
